<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">2 posts tagged with &quot;security&quot; | Navigating Blocks and Chains</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://harz.dev/img/header.jpg"><meta data-rh="true" name="twitter:image" content="https://harz.dev/img/header.jpg"><meta data-rh="true" property="og:url" content="https://harz.dev/blog/tags/security"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="2 posts tagged with &quot;security&quot; | Navigating Blocks and Chains"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harz.dev/blog/tags/security"><link data-rh="true" rel="alternate" href="https://harz.dev/blog/tags/security" hreflang="en"><link data-rh="true" rel="alternate" href="https://harz.dev/blog/tags/security" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Navigating Blocks and Chains RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Navigating Blocks and Chains Atom Feed">



<link rel="preconnect" href="https://harz_dev.goatcounter.com">
<script async src="//gc.zgo.at/count.js" data-goatcounter="https://harz_dev.goatcounter.com/count"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9fffcc12.css">
<link rel="preload" href="/assets/js/runtime~main.fc0da3ec.js" as="script">
<link rel="preload" href="/assets/js/main.7dba994f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/publications">Publications</a><a class="navbar__item navbar__link" href="/contact">Contact</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/rust-verification">Verifying Rust: Exploring Verification Options for Substrate</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/lean-execution">Lean Execution: How to Stay Focused</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/maker-collateral-attack">Stealing All of Maker&#x27;s Collateral</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/analysing-ethereum-gas-cost">Analysing Ethereum contract gas costs during development</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bitcoin-smart-contracts-mechanism-design">Analyzing Bitcoin smart contracts from a mechanism design perspective</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ethereum-python-integration">Integrating Python and Ethereum</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quantitative-finance-zipline">Quantitative finance with zipline</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/breaking-captchas">Breaking captchas: Using deep learning to automatically break CAPTCHAs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/dinvest-hedge-fund-on-a-blockchain">dInvest - hedge fund on a blockchain</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;security&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/rust-verification">Verifying Rust: Exploring Verification Options for Substrate</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-02-20T00:00:00.000Z" itemprop="datePublished">February 20, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://harz.dev" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/nud3l.png" alt="Dominik Harz"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://harz.dev" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Dominik Harz</span></a></div><small class="avatar__subtitle" itemprop="description">CTO Interlay</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Security is hard to get right in blockchains. It&#x27;s even harder to make sure that code is correct while still actively developing the product: code changes are frequent, requirements are changing, and the codebase is growing.</p><p>In this post, we&#x27;ll explore options for verifying blockchain code, specifically for the Substrate blockchain framework to try to verify the code of the <a href="https://www.github.com/interlay/interbtc" target="_blank" rel="noopener noreferrer">Interlay blockchain</a>. </p><p>My requirements for the test were simple: the tool should be integrated into the Rust toolchain (no DSLs) and I set myself a time limit of a single day to get started and get a useful result.</p><p>Spoiler alert: I managed to get two tools running and produce output. This post covers only the setup and I will follow up with more details in a future post.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-runtimes-as-verification-targets">Substrate Runtimes as Verification Targets<a href="#substrate-runtimes-as-verification-targets" class="hash-link" aria-label="Direct link to Substrate Runtimes as Verification Targets" title="Direct link to Substrate Runtimes as Verification Targets">​</a></h2><p>We are building the <a href="https://interlay.io" target="_blank" rel="noopener noreferrer">Interlay</a> and Kintsugi blockchains based on the Rust <a href="https://substrate.dev" target="_blank" rel="noopener noreferrer">Substrate</a> framework.
For verifying that the &quot;code is correct&quot;, we are looking for two targets:</p><ol><li><strong>Runtime</strong>: The WASM runtime encodes the rules of the blockchain subject to consensus verification. This is where we can potentially introduce logical errors in how the protocols are working or in their implementation such that we either impact the <em>safety</em> or <em>liveness</em> of the system.</li><li><strong>Node Implementation</strong>: The node implementation wraps around the runtime. Bugs introduced here can impact the <em>liveness</em> of the system.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="diving-into-verification">Diving into Verification<a href="#diving-into-verification" class="hash-link" aria-label="Direct link to Diving into Verification" title="Direct link to Diving into Verification">​</a></h2><p>Software verification is most often quite an academic exercise. With the adverse environment of blockchain development, there&#x27;s a clear benefit of increased security assurance in the software development process.
This goes hand in hand with the <a href="https://alastairreid.github.io/papers/HATRA_20/" target="_blank" rel="noopener noreferrer">desire of the verification community to integrate verification into the development process</a>.</p><p>I&#x27;ll not cover the usual testing and fuzzing tools but rather explore the three tools I found most accessible for verification in Rust.</p><p>My criteria for selecting tools were:</p><ol><li><strong>Actively maintained</strong>: The tool should be actively maintained and have a community around it. I checked the GitHub repositories for current contributions and when the last commit was made.</li><li><strong>Clear documentation</strong>: The tool should have clear documentation on how to use it and get started. If after 10 minutes of parsing the available documentation, I could not get a good understanding of how to install or use the tool, I would not use it.</li><li><strong>Rust integration</strong>: Since the idea is to integrate the tool into the normal development workflow, I was looking for a tool that integrates well with <code>cargo</code> and also does not require writing verification code in a language other than Rust.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="selected-tools">Selected Tools<a href="#selected-tools" class="hash-link" aria-label="Direct link to Selected Tools" title="Direct link to Selected Tools">​</a></h2><p>From the tools I found, I selected the following three tools for further exploration:</p><ul><li><a href="https://github.com/model-checking/kani" target="_blank" rel="noopener noreferrer">kani</a></li><li><a href="https://viperproject.github.io/prusti-dev/" target="_blank" rel="noopener noreferrer">Prusti</a></li><li><a href="https://github.com/facebookexperimental/MIRAI" target="_blank" rel="noopener noreferrer">MIRAI</a></li></ul><p>More tools are available on the <a href="https://rust-formal-methods.github.io/tools.html" target="_blank" rel="noopener noreferrer">Rust Formal Methods Interest Group</a> website and on <a href="https://alastairreid.github.io/automatic-rust-verification-tools-2021/" target="_blank" rel="noopener noreferrer">Alastair Reid&#x27;s blog</a>.</p><p>For all tools, I installed them and ran them without any additional configuration against the <a href="https://github.com/interlay/interbtc" target="_blank" rel="noopener noreferrer">chain implementation</a> of the Interlay blockchain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-note-on-expectations">A Note on Expectations<a href="#a-note-on-expectations" class="hash-link" aria-label="Direct link to A Note on Expectations" title="Direct link to A Note on Expectations">​</a></h3><p>I would be happy if a tool runs on the first try: installing the tool without issues and scanning the code base without setting up verification rules. Overall, the code is well-tested, but it is very complex: more than 1,000 dependencies, almost 100,000 lines of code, and invoking external C libraries.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kani">kani<a href="#kani" class="hash-link" aria-label="Direct link to kani" title="Direct link to kani">​</a></h2><p>From the <a href="https://model-checking.github.io/kani/getting-started.html" target="_blank" rel="noopener noreferrer">developer&#x27;s website</a>:</p><blockquote><p>Kani is an open-source verification tool that uses model checking to analyze Rust programs. Kani is particularly useful for verifying unsafe code in Rust, where many of the Rust’s usual guarantees are no longer checked by the compiler.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting started<a href="#getting-started" class="hash-link" aria-label="Direct link to Getting started" title="Direct link to Getting started">​</a></h3><p>I found getting started very easy with just two commands to execute:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> --locked kani-verifier</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo kani setup</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, I ran kani against the runtime of the Interlay blockchain:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># From the interbtc repo root</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo kani</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-errors">Compilation Errors<a href="#compilation-errors" class="hash-link" aria-label="Direct link to Compilation Errors" title="Direct link to Compilation Errors">​</a></h3><p>That produced the following error during the compilation of the <code>schnorrkel</code> crate:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">error: </span><span class="token function" style="color:rgb(80, 250, 123)">format</span><span class="token plain"> argument must be a string literal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> /home/nud3l/.cargo/registry/src/github.com-1ecc6299db9ec823/schnorrkel-0.9.1/src/batch.rs:165:47</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">165</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">     assert</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hrams.len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> public_keys.len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">, ASSERT_MESSAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                                               ^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">help: you might be missing a string literal to </span><span class="token function" style="color:rgb(80, 250, 123)">format</span><span class="token plain"> with</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">165</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">     assert</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">hrams.len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> public_keys.len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;{}&quot;</span><span class="token plain">, ASSERT_MESSAGE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                                               +++++</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, I wasn&#x27;t sure how to convince kani to ignore these errors in the dependencies. I tried running kani only on a single crate but it resulted in the same compiler issue.</p><p>The authors have a guide on how to get started with <a href="https://model-checking.github.io/kani/tutorial-real-code.html" target="_blank" rel="noopener noreferrer">real code</a> but it does not include how to handle compiler errors in dependencies.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prusti">Prusti<a href="#prusti" class="hash-link" aria-label="Direct link to Prusti" title="Direct link to Prusti">​</a></h2><p>From the <a href="https://viperproject.github.io/prusti-dev/" target="_blank" rel="noopener noreferrer">developer&#x27;s website</a>:</p><blockquote><p>Prusti is a verification tool for Rust programs. It is based on the Rust compiler and uses the Rust type system to verify Rust programs. Prusti is a research prototype and is not yet ready for production use.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started-1">Getting started<a href="#getting-started-1" class="hash-link" aria-label="Direct link to Getting started" title="Direct link to Getting started">​</a></h3><p>Getting started with Prusti required downloading the Prusti Assistant VS Code extension.
I already had the required Java SDk and <code>rustup</code> versions installed so the process of getting started only involved opening a rust file and hitting the &quot;Verify with Prusti&quot; button on the VS Code status bar.</p><p><img loading="lazy" alt="Prusti" src="/assets/images/prusti-03fc7621aaa000baec571b5bb93e5210.png" width="774" height="1079" class="img_ev3q"></p><p>As the first target, the <a href="https://github.com/interlay/interbtc/blob/master/crates/fee/src/lib.rs" target="_blank" rel="noopener noreferrer">fee pallet</a> seemed interesting as it&#x27;s mildly complex, has few dependencies, and with its fixed point math might be subject to issues.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="errors">Errors<a href="#errors" class="hash-link" aria-label="Direct link to Errors" title="Direct link to Errors">​</a></h3><p>On the first run on the fee crate, Prusti found 358 errors. That seemed quite a lot but after initial inspection, most of the errors were:</p><ul><li>Unsupported features (313 errors): I was expecting Prusti with its <a href="https://viperproject.github.io/prusti-dev/user-guide/verify/summary.html" target="_blank" rel="noopener noreferrer">current feature set</a> to run into these issues as substrate makes heavy use of macros, traits, and other advanced features of Rust.</li><li>Internal errors (24 errors): Several internal errors occured.</li><li>Unexpected verification error (9 errors): Some verification failed.</li><li>Verification errors (14 errors): These seem to be the ones worth investigating.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="success">Success<a href="#success" class="hash-link" aria-label="Direct link to Success" title="Direct link to Success">​</a></h3><p>Prusti found potential overflow and underflow errors in the bitcoin crate:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// bitcoin/src/parser.rs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> position </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> raw_bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">EndOfFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also found possible issues with unbounded arrays:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// bitcoin/src/script.rs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pub</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">op_return</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">return_content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">u8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Script</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mut</span><span class="token plain"> script </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">Script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token function" style="color:rgb(80, 250, 123)">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">OpCode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">OpReturn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">return_content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">u8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">append</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">return_content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mirai">MIRAI<a href="#mirai" class="hash-link" aria-label="Direct link to MIRAI" title="Direct link to MIRAI">​</a></h2><p>From the <a href="https://github.com/facebookexperimental/MIRAI" target="_blank" rel="noopener noreferrer">developer&#x27;s website</a>:</p><blockquote><p>MIRAI is an abstract interpreter for the Rust compiler&#x27;s mid-level intermediate representation (MIR). It is intended to become a widely used static analysis tool for Rust.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started-2">Getting started<a href="#getting-started-2" class="hash-link" aria-label="Direct link to Getting started" title="Direct link to Getting started">​</a></h3><p>Installation of MIRAI was straightforward, following the <a href="https://github.com/facebookexperimental/MIRAI/blob/main/documentation/InstallationGuide.md" target="_blank" rel="noopener noreferrer">guide</a>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> clone https://github.com/facebookexperimental/MIRAI.git</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> MIRAI</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> --locked --path ./checker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, I ran MIRAI in the interbtc root directory.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo mirai</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-errors-1">Compilation Errors<a href="#compilation-errors-1" class="hash-link" aria-label="Direct link to Compilation Errors" title="Direct link to Compilation Errors">​</a></h3><p>MIRAI produces compilation errors on the wasm builds:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">     Compiling wasm-test v1.0.0 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">/tmp/.tmpfNz4QS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">E0463</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">: can&#x27;t </span><span class="token function" style="color:rgb(80, 250, 123)">find</span><span class="token plain"> crate </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">std</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">=</span><span class="token plain"> note: the </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">wasm32-unknown-unknown</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> target may not be installed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">=</span><span class="token plain"> help: consider downloading the target with </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">rustup target </span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">add</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> wasm32-unknown-unknown</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">=</span><span class="token plain"> help: consider building the standard library from </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">source</span><span class="token plain"> with </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">cargo build -Zbuild-std</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  error: requires </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">sized</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> lang_item</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  For </span><span class="token function" style="color:rgb(80, 250, 123)">more</span><span class="token plain"> information about this error, try </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">rustc --explain E0463</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  error: could not compile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">wasm-test</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> due to </span><span class="token number">2</span><span class="token plain"> previous errors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  warning: build failed, waiting </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> other </span><span class="token function" style="color:rgb(80, 250, 123)">jobs</span><span class="token plain"> to finish</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  error: cannot </span><span class="token function" style="color:rgb(80, 250, 123)">find</span><span class="token plain"> macro </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">println</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> this scope</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> src/main.rs:3:5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token number">3</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">                 println</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;{}&quot;</span><span class="token plain">, env</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;RUSTC_VERSION&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">))</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                 ^^^^^^^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  error: could not compile </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">wasm-test</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> due to </span><span class="token number">3</span><span class="token plain"> previous errors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="success-1">Success<a href="#success-1" class="hash-link" aria-label="Direct link to Success" title="Direct link to Success">​</a></h3><p>As the wasm build is done on the entire runtime, I decided to try my luck against a single pallet instead. Similar to before, I tried the fee crate. This worked and to my surprise, MIRAI did not print any warnings or errors.</p><p>Next, I tried the bitcoin create that implements parsing and other somewhat error prone code. MIRAI gave me results here:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">warning: possible attempt to subtract with overflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> crates/bitcoin/src/parser.rs:239:24</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">239</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">let</span><span class="token plain"> target: U256 </span><span class="token operator">=</span><span class="token plain"> parser.parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                        ^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">note: related location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> crates/bitcoin/src/parser.rs:177:40</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">177</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">         </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">let</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">result, bytes_consumed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> T::parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token plain">self.raw_bytes, self.position</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">note: related location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> crates/bitcoin/src/parser.rs:151:23</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">151</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain">         </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">let</span><span class="token plain"> compact </span><span class="token operator">=</span><span class="token plain"> U256::set_compact</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">bits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">.ok_or</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Error::InvalidCompact</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                       ^^^^^^^^^^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">note: related location</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   --</span><span class="token operator">&gt;</span><span class="token plain"> crates/bitcoin/src/math.rs:53:25</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">53</span><span class="token plain">  </span><span class="token operator">|</span><span class="token plain">             word </span><span class="token operator">&lt;&lt;</span><span class="token plain"> </span><span class="token number">8</span><span class="token plain"> * </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">size - </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain">                         ^^^^^^^^^^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2><p>Overall, I was very happy with the results. I was able to run two tools against the crates without additional configuration and they found potential issues. Next up will be trying to implement custom verification rules and dive deeper into the identified issues.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/blockchain">blockchain</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/security">security</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/software-engineering">software-engineering</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/maker-collateral-attack">Stealing All of Maker&#x27;s Collateral</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-02-20T00:00:00.000Z" itemprop="datePublished">February 20, 2020</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://harz.dev" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/nud3l.png" alt="Dominik Harz"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://harz.dev" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Dominik Harz</span></a></div><small class="avatar__subtitle" itemprop="description">CTO Interlay</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Or why Oracle Vulnerabilities are not the Worst Application of Flash Loans.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">tl;dr<a href="#tldr" class="hash-link" aria-label="Direct link to tl;dr" title="Direct link to tl;dr">​</a></h2><ul><li>You can potentially steal all of Maker’s collateral ($700m) and issue arbitrary amounts of new Dai using flash loans if no delay for new governance contracts is introduced.</li><li>Anyone can execute the attack and only needs to pay the transaction fees (few $) without holding any MKR.</li><li>If Maker does not introduce a delay until the liquidity pools for flash loan pools gets above a threshold, there is little chance to prevent the attack (race condition).</li><li>We have reached out to Maker February 8, 2020 about our research and had a call with them on February 14, 2020 to discuss our findings. Maker is aware of the attack vector <a href="https://forum.makerdao.com/t/all-mkr-holders-on-friday-12pm-pst-please-vote-for-the-gsm-to-be-activated/1303" target="_blank" rel="noopener noreferrer">and is holding a vote this Friday 12pm PST that would prevent the attack</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>Maker and its Dai stablecoin is the most popular so-called decentralized finance (DeFi) project on Ethereum with around of $700m locked in its smart contracts. The Maker protocol relies on a governance process encoded in a smart contract. MKR token holders can vote to replace an existing governance contract. Votes are proportional to the amount of MKR. The total number of MKR tokens is around 987,530 <a href="https://etherscan.io/token/0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2#balances" target="_blank" rel="noopener noreferrer">where selected wallets or contracts hold large quantities of the token</a>:</p><ul><li>[Maker Governance Contract: 192,910 MKR]</li><li>Maker Foundation: 117,993 MKR</li><li>a16z: 60,000 MKR</li><li>0xfc7e22c6afa3ebb723bdde26d6ab3783aab9726b: 51,291 MKR</li><li>0x000be27f560fef0253cac4da8411611184356549: 39,645 MKR</li></ul><p>Note: the Maker Governance Contract contains MKR tokens of multiple parties.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="governance-attack">Governance Attack<a href="#governance-attack" class="hash-link" aria-label="Direct link to Governance Attack" title="Direct link to Governance Attack">​</a></h2><p>In a <a href="https://medium.com/coinmonks/how-to-turn-20m-into-340m-in-15-seconds-48d161a42311" target="_blank" rel="noopener noreferrer">post from December 2019, Micah Zoltu</a> pointed out how to attack the Maker governance contract. The basic idea is to accumulate enough MKR tokens to replace the existing governance contract with the attackers, malicious, governance contract. The malicious governance contract is then able to give the attacker full control over the system and withdraw any collateral in the system as well as create arbitrary amounts of new Dai.</p><p>To reduce the number of required MKR tokens, he proposed to execute the attack when new governance contracts are being voted on. At the moment, 192,910 MKR tokens are locked in the governance contract. However, an attacker would need less tokens if, say two or three contracts, would be voted on in parallel with similar token distributions. This frequently happened in the past as we can observe in the graph below:</p><p><img loading="lazy" src="/assets/images/mkr_locked-79e0b1ef4dcbf0f4e43816d4364c5e75.webp" width="640" height="480" class="img_ev3q"></p><p>The obvious attack strategy would be to crowd-fund the required MKR tokens through a smart contract and pay each attacker a share of the of the winnings. However, the attackers need to amass probably around 50k MKR tokens to have a chance to attack the system without Maker noticing these movements. We do show a strategy for this in our <a href="https://arxiv.org/abs/2002.08099" target="_blank" rel="noopener noreferrer">latest paper</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-brave-new-attack-strategy-flash-loans">A Brave New Attack Strategy: Flash Loans<a href="#a-brave-new-attack-strategy-flash-loans" class="hash-link" aria-label="Direct link to A Brave New Attack Strategy: Flash Loans" title="Direct link to A Brave New Attack Strategy: Flash Loans">​</a></h2><p>However, we can completely lift the requirement to amass MKR tokens if we consider using flash loans instead. Flash loans are a fairly new concept and therefore we give a brief explanation here. Normally, an agent has to provide collateral to take out a loan in the DeFi space. For example, in Maker, Alice can borrow Dai by depositing ETH. This is required since we operate under a model of <a href="https://bdlt.school/files/slides/talk-rainer-b%C3%B6hme-a-primer-on-economics-for-cryptocurrencies.pdf" target="_blank" rel="noopener noreferrer">weak identities</a> and <a href="https://eprint.iacr.org/2019/675" target="_blank" rel="noopener noreferrer">economically rational agents</a>.</p><p>A flash loan lifts this requirement as it only takes place in a single transaction:</p><ol><li>Alice takes out the loan from a flash loan liquidity provider (e.g. Aave or dYdX)</li><li>Alice executes some actions (e.g. arbitrage trading on Uniswap, Fulcrum, Kyber etc.)</li><li>Alice pays back the flash loan with interest</li></ol><p>A flash loan works in three steps within a single transaction.</p><p><img loading="lazy" src="/assets/images/flash-loan-ad22ea3dffc0db7e13540ee02ccca7ac.webp" width="966" height="389" class="img_ev3q"></p><p>The flash loan works because of how the Ethereum Virtual Machine is designed: if at any point during this transaction the flash loan fails, the whole transaction is reverted. Hence, Alice can take the loan risk free, i.e. if she cannot pay it back it would be like she would have never taken it. The liquidity providers are also winning: they have only lent their funds if Alice was able to pay them back.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrage-and-oracle-manipulation-with-flash-loans">Arbitrage and Oracle Manipulation with Flash Loans<a href="#arbitrage-and-oracle-manipulation-with-flash-loans" class="hash-link" aria-label="Direct link to Arbitrage and Oracle Manipulation with Flash Loans" title="Direct link to Arbitrage and Oracle Manipulation with Flash Loans">​</a></h2><p>On February 14 and February 18, two incidents involving flash loans occurred that caused <a href="https://bzx.network/" target="_blank" rel="noopener noreferrer">bZx</a> to halt its platform. In the <a href="https://etherscan.io/tx/0xb5c8bd9430b6cc87a0e2fe110ece6bf527fa4f170a4bc8cd032f768fc5219838" target="_blank" rel="noopener noreferrer">first transaction</a>, a single flash loan was able to make a profit of 1,193 ETH (approx. $298,250). This transaction was executed using a smart contract that opened a short position on Fulcrum on wBTC. In the same transaction, the transaction took out a wBTC loan on Compound and executed a trade of wBTC on Kyber’s Uniswap reserve resulting in slippage ultimately bringing down the price on Fulcrum as well. The full details can be found in the <a href="https://bzx.network/blog/postmortem-ethdenver" target="_blank" rel="noopener noreferrer">post-mortem by bZx</a> and a <a href="https://medium.com/@peckshield/bzx-hack-full-disclosure-with-detailed-profit-analysis-e6b1fa9b18fc" target="_blank" rel="noopener noreferrer">detailed analysis of the involved calls by PeckShield</a>.</p><p>Similarly, a second incident occurred on February 18 where in a <a href="https://etherscan.io/tx/0x762881b07feb63c436dee38edd4ff1f7a74c33091e534af56c9f7d49b5ecac15" target="_blank" rel="noopener noreferrer">single transaction</a> a profit of 2,378 ETH (approx. $600,000) was made. This transaction involved an initial borrowing of 7,500 ETH to take a long position on <a href="https://www.synthetix.io/tokens/" target="_blank" rel="noopener noreferrer">Synthetix&#x27;</a> sUSD. More details are found in this <a href="https://twitter.com/DegenSpartan/status/1229646531717820416?s=20" target="_blank" rel="noopener noreferrer">informal analysis</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oracle-manipulation-to-reduce-required-liquidity">Oracle Manipulation to Reduce Required Liquidity<a href="#oracle-manipulation-to-reduce-required-liquidity" class="hash-link" aria-label="Direct link to Oracle Manipulation to Reduce Required Liquidity" title="Direct link to Oracle Manipulation to Reduce Required Liquidity">​</a></h2><p>For our attack, we assume that 50k MKR are sufficient. Even if in practice the number of tokens could be higher, we point out how the concept of flash loans makes securing Maker, without a governance delay, hard. In a naive approach, the attacker could take out a flash loan to buy 50k MKR tokens.</p><p>At current exchange rates, the attacker <a href="https://dexindex.io/?symbol=MKR&amp;amount=50000&amp;action=buy" target="_blank" rel="noopener noreferrer">needs around 485,000 ETH to buy that amount of MKR as only a single exchange</a>, Kyber, has enough volume available. However, the attacker can also leverage multiple exchanges and buy 38k MKR from Kyber, 11.5k from Uniswap, and 500 MKR from Switcheo for a total of 378,940 ETH. That number is still high but already a reduction by almost 100,000 ETH!</p><p>An attacker can use the oracle manipulation strategies above to effectively bring down the price of MKR on Kyber and Uniswap. These are the two largest providers of MKR and have shown to be vulnerable to oracle price manipulation. Further analysis is required to determine how much the MKR price can be reduced. However, on a less liquid token like wBTC an <a href="https://medium.com/@peckshield/bzx-hack-full-disclosure-with-detailed-profit-analysis-e6b1fa9b18fc" target="_blank" rel="noopener noreferrer">attacker was able manipulate the exchange rate by around 285%</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="obtaining-enough-liquidity">Obtaining enough Liquidity<a href="#obtaining-enough-liquidity" class="hash-link" aria-label="Direct link to Obtaining enough Liquidity" title="Direct link to Obtaining enough Liquidity">​</a></h2><p><img loading="lazy" alt="eth-locked.webp" src="/assets/images/eth-locked-49ebf20958f73b922d3811a3aceafa28.webp" width="786" height="412" class="img_ev3q"></p><p>Even with oracle manipulation, a large number of ETH is required to execute the attack on Maker. However, an attacker can increase its liquidity by taking out two flash loans within the same transaction. Aave and dYdX protect themselves against reentrancy and allow only a single flash loan within a single transaction. But the attacker can borrow ETH from both protocols within the same transaction.</p><p><img loading="lazy" src="/assets/images/eth-locked-dydx-71e47f9a802fa4f73b434ccd6f490d88.webp" width="783" height="413" class="img_ev3q"></p><p>Thus, as of February 18, the attacker has a pool of around <a href="https://trade.dydx.exchange/markets" target="_blank" rel="noopener noreferrer">90k ETH on dYdX</a> plus <a href="https://app.aave.com/borrow/ETH" target="_blank" rel="noopener noreferrer">17k ETH on Aave</a> available. Hence, at current liquidity rates an attacker could take out a combined ~107k ETH loan from both dYdX and Aave to try to manipulate the MKR token price and obtain enough MKR tokens to replace the current Maker governance contract with its own.</p><p>For this to succeed the attacker must be able to reduce average MKR price by at least 3.54 times. Alternatively, the attacker can also wait for dYdX and Aave to increase its liquidity pools. With the current growth rate of around 5% of both protocols, it does not seem unlikely that the attack becomes possible within two months.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="combination">Combination?<a href="#combination" class="hash-link" aria-label="Direct link to Combination?" title="Direct link to Combination?">​</a></h2><p>Obviously, it is possible to combine the crowd funding approach and the flash loan together. Using the available liquidity of ~107k ETH, it is possible to obtain around 10,800 MKR from Kyber. This would allow multiple attackers to reduce the required amount of pooling together 50k MKR to just around 39.2k MKR. It seems also that some people are indeed interested in such an attack as this informal Twitter poll shows:</p><p><img loading="lazy" src="/assets/images/twitter-ca74db5863009f30e89defb4e12a4a17.webp" width="786" height="376" class="img_ev3q"></p><p><a href="https://etherscan.io/token/0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2#balances" target="_blank" rel="noopener noreferrer">It can also be noted that the top four account holders</a> (in fact five, but not considering the current Maker Governance Contract) are able to execute the attack without crowdfunding.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="no-time-to-wait">No Time to Wait<a href="#no-time-to-wait" class="hash-link" aria-label="Direct link to No Time to Wait" title="Direct link to No Time to Wait">​</a></h2><p>Once enough liquidity is available through the flash loan lending pools (with or without the combination of using oracle manipulation), anyone is able to take over the Maker governance contract. Once Maker starts a vote when the liquidity pools have reached that threshold, Maker needs to ensure that MKR tokens are as little distributed as possible. If the distribution of MKR at any point in this voting procedure allows for an exploit of the vulnerability, any collateral can be taken away.</p><p>That attacker would be able to steal $700m worth of ETH collateral and be able to print new Dai at will. This attack would spread throughout the whole DeFi space as Dai is used as backing collateral in other protocols. Further, the attacker can use his Dai to trade other currencies worth around $230m. <a href="https://arxiv.org/abs/2002.08099" target="_blank" rel="noopener noreferrer">We give a more detailed analysis in our paper.</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="counter-measure">Counter measure<a href="#counter-measure" class="hash-link" aria-label="Direct link to Counter measure" title="Direct link to Counter measure">​</a></h2><p>Maker should put a new governance contract in place that prevents flash loans from attacking their system. Specifically, a new governance contract should be able to be checked by the Maker Foundation for malicious code and give enough time to react. At the bare minimum, a new governance contract should not be able to go live within a single transaction. That way, the attacker can likely not profit from the attack and thus not repay the flash loan.
If the attacker cannot repay the flash loan, the attack is like it would have never happened.</p><p>Maker is putting such a contract to vote on Friday, 12pm PST, February 21, 2020. <a href="https://forum.makerdao.com/t/all-mkr-holders-on-friday-12pm-pst-please-vote-for-the-gsm-to-be-activated/1303/2" target="_blank" rel="noopener noreferrer">The proposed contract would activate the Governance Security Module (GSM) and prevent such a flash loan attack.</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/de-fi">DeFi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/maker-dao">MakerDAO</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/security">Security</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/flashloans">Flashloans</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Dominik Harz. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fc0da3ec.js"></script>
<script src="/assets/js/main.7dba994f.js"></script>
</body>
</html>