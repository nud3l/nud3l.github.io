"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7160],{3905:(e,t,a)=>{a.d(t,{Zo:()=>h,kt:()=>m});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},h=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,h=l(e,["components","mdxType","originalType","parentName"]),u=c(a),p=o,m=u["".concat(s,".").concat(p)]||u[p]||d[p]||r;return a?n.createElement(m,i(i({ref:t},h),{},{components:a})):n.createElement(m,i({ref:t},h))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},2110:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var n=a(7462),o=(a(7294),a(3905));const r={slug:"maker-collateral-attack",title:"Stealing All of Maker's Collateral",tags:["DeFi","MakerDAO","Security","Flashloans"],authors:"dom"},i=void 0,l={permalink:"/blog/maker-collateral-attack",editUrl:"https://github.com/nud3l/nud3l.github.io/blog/2020-02-20-maker/index.md",source:"@site/blog/2020-02-20-maker/index.md",title:"Stealing All of Maker's Collateral",description:"Or why Oracle Vulnerabilities are not the Worst Application of Flash Loans.",date:"2020-02-20T00:00:00.000Z",formattedDate:"February 20, 2020",tags:[{label:"DeFi",permalink:"/blog/tags/de-fi"},{label:"MakerDAO",permalink:"/blog/tags/maker-dao"},{label:"Security",permalink:"/blog/tags/security"},{label:"Flashloans",permalink:"/blog/tags/flashloans"}],readingTime:8.14,hasTruncateMarker:!1,authors:[{name:"Dominik Harz",title:"CTO Interlay",url:"https://harz.dev",imageURL:"https://github.com/nud3l.png",key:"dom"}],frontMatter:{slug:"maker-collateral-attack",title:"Stealing All of Maker's Collateral",tags:["DeFi","MakerDAO","Security","Flashloans"],authors:"dom"},prevItem:{title:"Lean Execution: How to Stay Focused",permalink:"/blog/lean-execution"},nextItem:{title:"Analysing Ethereum contract gas costs during development",permalink:"/blog/analysing-ethereum-gas-cost"}},s={authorsImageUrls:[void 0]},c=[{value:"tl;dr",id:"tldr",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Governance Attack",id:"governance-attack",level:2},{value:"A Brave New Attack Strategy: Flash Loans",id:"a-brave-new-attack-strategy-flash-loans",level:2},{value:"Arbitrage and Oracle Manipulation with Flash Loans",id:"arbitrage-and-oracle-manipulation-with-flash-loans",level:2},{value:"Oracle Manipulation to Reduce Required Liquidity",id:"oracle-manipulation-to-reduce-required-liquidity",level:2},{value:"Obtaining enough Liquidity",id:"obtaining-enough-liquidity",level:2},{value:"Combination?",id:"combination",level:2},{value:"No Time to Wait",id:"no-time-to-wait",level:2},{value:"Counter measure",id:"counter-measure",level:2}],h={toc:c},u="wrapper";function d(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,n.Z)({},h,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Or why Oracle Vulnerabilities are not the Worst Application of Flash Loans."),(0,o.kt)("h2",{id:"tldr"},"tl;dr"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You can potentially steal all of Maker\u2019s collateral ($700m) and issue arbitrary amounts of new Dai using flash loans if no delay for new governance contracts is introduced."),(0,o.kt)("li",{parentName:"ul"},"Anyone can execute the attack and only needs to pay the transaction fees (few $) without holding any MKR."),(0,o.kt)("li",{parentName:"ul"},"If Maker does not introduce a delay until the liquidity pools for flash loan pools gets above a threshold, there is little chance to prevent the attack (race condition)."),(0,o.kt)("li",{parentName:"ul"},"We have reached out to Maker February 8, 2020 about our research and had a call with them on February 14, 2020 to discuss our findings. Maker is aware of the attack vector ",(0,o.kt)("a",{parentName:"li",href:"https://forum.makerdao.com/t/all-mkr-holders-on-friday-12pm-pst-please-vote-for-the-gsm-to-be-activated/1303"},"and is holding a vote this Friday 12pm PST that would prevent the attack"),".")),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"Maker and its Dai stablecoin is the most popular so-called decentralized finance (DeFi) project on Ethereum with around of $700m locked in its smart contracts. The Maker protocol relies on a governance process encoded in a smart contract. MKR token holders can vote to replace an existing governance contract. Votes are proportional to the amount of MKR. The total number of MKR tokens is around 987,530 ",(0,o.kt)("a",{parentName:"p",href:"https://etherscan.io/token/0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2#balances"},"where selected wallets or contracts hold large quantities of the token"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"[Maker Governance Contract: 192,910 MKR]"),(0,o.kt)("li",{parentName:"ul"},"Maker Foundation: 117,993 MKR"),(0,o.kt)("li",{parentName:"ul"},"a16z: 60,000 MKR"),(0,o.kt)("li",{parentName:"ul"},"0xfc7e22c6afa3ebb723bdde26d6ab3783aab9726b: 51,291 MKR"),(0,o.kt)("li",{parentName:"ul"},"0x000be27f560fef0253cac4da8411611184356549: 39,645 MKR")),(0,o.kt)("p",null,"Note: the Maker Governance Contract contains MKR tokens of multiple parties."),(0,o.kt)("h2",{id:"governance-attack"},"Governance Attack"),(0,o.kt)("p",null,"In a ",(0,o.kt)("a",{parentName:"p",href:"https://medium.com/coinmonks/how-to-turn-20m-into-340m-in-15-seconds-48d161a42311"},"post from December 2019, Micah Zoltu")," pointed out how to attack the Maker governance contract. The basic idea is to accumulate enough MKR tokens to replace the existing governance contract with the attackers, malicious, governance contract. The malicious governance contract is then able to give the attacker full control over the system and withdraw any collateral in the system as well as create arbitrary amounts of new Dai."),(0,o.kt)("p",null,"To reduce the number of required MKR tokens, he proposed to execute the attack when new governance contracts are being voted on. At the moment, 192,910 MKR tokens are locked in the governance contract. However, an attacker would need less tokens if, say two or three contracts, would be voted on in parallel with similar token distributions. This frequently happened in the past as we can observe in the graph below:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(8314).Z,width:"640",height:"480"})),(0,o.kt)("p",null,"The obvious attack strategy would be to crowd-fund the required MKR tokens through a smart contract and pay each attacker a share of the of the winnings. However, the attackers need to amass probably around 50k MKR tokens to have a chance to attack the system without Maker noticing these movements. We do show a strategy for this in our ",(0,o.kt)("a",{parentName:"p",href:"https://arxiv.org/abs/2002.08099"},"latest paper"),"."),(0,o.kt)("h2",{id:"a-brave-new-attack-strategy-flash-loans"},"A Brave New Attack Strategy: Flash Loans"),(0,o.kt)("p",null,"However, we can completely lift the requirement to amass MKR tokens if we consider using flash loans instead. Flash loans are a fairly new concept and therefore we give a brief explanation here. Normally, an agent has to provide collateral to take out a loan in the DeFi space. For example, in Maker, Alice can borrow Dai by depositing ETH. This is required since we operate under a model of ",(0,o.kt)("a",{parentName:"p",href:"https://bdlt.school/files/slides/talk-rainer-b%C3%B6hme-a-primer-on-economics-for-cryptocurrencies.pdf"},"weak identities")," and ",(0,o.kt)("a",{parentName:"p",href:"https://eprint.iacr.org/2019/675"},"economically rational agents"),"."),(0,o.kt)("p",null,"A flash loan lifts this requirement as it only takes place in a single transaction:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Alice takes out the loan from a flash loan liquidity provider (e.g. Aave or dYdX)"),(0,o.kt)("li",{parentName:"ol"},"Alice executes some actions (e.g. arbitrage trading on Uniswap, Fulcrum, Kyber etc.)"),(0,o.kt)("li",{parentName:"ol"},"Alice pays back the flash loan with interest")),(0,o.kt)("p",null,"A flash loan works in three steps within a single transaction."),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(6187).Z,width:"966",height:"389"})),(0,o.kt)("p",null,"The flash loan works because of how the Ethereum Virtual Machine is designed: if at any point during this transaction the flash loan fails, the whole transaction is reverted. Hence, Alice can take the loan risk free, i.e. if she cannot pay it back it would be like she would have never taken it. The liquidity providers are also winning: they have only lent their funds if Alice was able to pay them back."),(0,o.kt)("h2",{id:"arbitrage-and-oracle-manipulation-with-flash-loans"},"Arbitrage and Oracle Manipulation with Flash Loans"),(0,o.kt)("p",null,"On February 14 and February 18, two incidents involving flash loans occurred that caused ",(0,o.kt)("a",{parentName:"p",href:"https://bzx.network/"},"bZx")," to halt its platform. In the ",(0,o.kt)("a",{parentName:"p",href:"https://etherscan.io/tx/0xb5c8bd9430b6cc87a0e2fe110ece6bf527fa4f170a4bc8cd032f768fc5219838"},"first transaction"),", a single flash loan was able to make a profit of 1,193 ETH (approx. $298,250). This transaction was executed using a smart contract that opened a short position on Fulcrum on wBTC. In the same transaction, the transaction took out a wBTC loan on Compound and executed a trade of wBTC on Kyber\u2019s Uniswap reserve resulting in slippage ultimately bringing down the price on Fulcrum as well. The full details can be found in the ",(0,o.kt)("a",{parentName:"p",href:"https://bzx.network/blog/postmortem-ethdenver"},"post-mortem by bZx")," and a ",(0,o.kt)("a",{parentName:"p",href:"https://medium.com/@peckshield/bzx-hack-full-disclosure-with-detailed-profit-analysis-e6b1fa9b18fc"},"detailed analysis of the involved calls by PeckShield"),"."),(0,o.kt)("p",null,"Similarly, a second incident occurred on February 18 where in a ",(0,o.kt)("a",{parentName:"p",href:"https://etherscan.io/tx/0x762881b07feb63c436dee38edd4ff1f7a74c33091e534af56c9f7d49b5ecac15"},"single transaction")," a profit of 2,378 ETH (approx. $600,000) was made. This transaction involved an initial borrowing of 7,500 ETH to take a long position on ",(0,o.kt)("a",{parentName:"p",href:"https://www.synthetix.io/tokens/"},"Synthetix'")," sUSD. More details are found in this ",(0,o.kt)("a",{parentName:"p",href:"https://twitter.com/DegenSpartan/status/1229646531717820416?s=20"},"informal analysis"),"."),(0,o.kt)("h2",{id:"oracle-manipulation-to-reduce-required-liquidity"},"Oracle Manipulation to Reduce Required Liquidity"),(0,o.kt)("p",null,"For our attack, we assume that 50k MKR are sufficient. Even if in practice the number of tokens could be higher, we point out how the concept of flash loans makes securing Maker, without a governance delay, hard. In a naive approach, the attacker could take out a flash loan to buy 50k MKR tokens."),(0,o.kt)("p",null,"At current exchange rates, the attacker ",(0,o.kt)("a",{parentName:"p",href:"https://dexindex.io/?symbol=MKR&amount=50000&action=buy"},"needs around 485,000 ETH to buy that amount of MKR as only a single exchange"),", Kyber, has enough volume available. However, the attacker can also leverage multiple exchanges and buy 38k MKR from Kyber, 11.5k from Uniswap, and 500 MKR from Switcheo for a total of 378,940 ETH. That number is still high but already a reduction by almost 100,000 ETH!"),(0,o.kt)("p",null,"An attacker can use the oracle manipulation strategies above to effectively bring down the price of MKR on Kyber and Uniswap. These are the two largest providers of MKR and have shown to be vulnerable to oracle price manipulation. Further analysis is required to determine how much the MKR price can be reduced. However, on a less liquid token like wBTC an ",(0,o.kt)("a",{parentName:"p",href:"https://medium.com/@peckshield/bzx-hack-full-disclosure-with-detailed-profit-analysis-e6b1fa9b18fc"},"attacker was able manipulate the exchange rate by around 285%"),"."),(0,o.kt)("h2",{id:"obtaining-enough-liquidity"},"Obtaining enough Liquidity"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"eth-locked.webp",src:a(590).Z,width:"786",height:"412"})),(0,o.kt)("p",null,"Even with oracle manipulation, a large number of ETH is required to execute the attack on Maker. However, an attacker can increase its liquidity by taking out two flash loans within the same transaction. Aave and dYdX protect themselves against reentrancy and allow only a single flash loan within a single transaction. But the attacker can borrow ETH from both protocols within the same transaction."),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(2125).Z,width:"783",height:"413"})),(0,o.kt)("p",null,"Thus, as of February 18, the attacker has a pool of around ",(0,o.kt)("a",{parentName:"p",href:"https://trade.dydx.exchange/markets"},"90k ETH on dYdX")," plus ",(0,o.kt)("a",{parentName:"p",href:"https://app.aave.com/borrow/ETH"},"17k ETH on Aave")," available. Hence, at current liquidity rates an attacker could take out a combined ~107k ETH loan from both dYdX and Aave to try to manipulate the MKR token price and obtain enough MKR tokens to replace the current Maker governance contract with its own."),(0,o.kt)("p",null,"For this to succeed the attacker must be able to reduce average MKR price by at least 3.54 times. Alternatively, the attacker can also wait for dYdX and Aave to increase its liquidity pools. With the current growth rate of around 5% of both protocols, it does not seem unlikely that the attack becomes possible within two months."),(0,o.kt)("h2",{id:"combination"},"Combination?"),(0,o.kt)("p",null,"Obviously, it is possible to combine the crowd funding approach and the flash loan together. Using the available liquidity of ~107k ETH, it is possible to obtain around 10,800 MKR from Kyber. This would allow multiple attackers to reduce the required amount of pooling together 50k MKR to just around 39.2k MKR. It seems also that some people are indeed interested in such an attack as this informal Twitter poll shows:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:a(13).Z,width:"786",height:"376"})),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://etherscan.io/token/0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2#balances"},"It can also be noted that the top four account holders")," (in fact five, but not considering the current Maker Governance Contract) are able to execute the attack without crowdfunding."),(0,o.kt)("h2",{id:"no-time-to-wait"},"No Time to Wait"),(0,o.kt)("p",null,"Once enough liquidity is available through the flash loan lending pools (with or without the combination of using oracle manipulation), anyone is able to take over the Maker governance contract. Once Maker starts a vote when the liquidity pools have reached that threshold, Maker needs to ensure that MKR tokens are as little distributed as possible. If the distribution of MKR at any point in this voting procedure allows for an exploit of the vulnerability, any collateral can be taken away."),(0,o.kt)("p",null,"That attacker would be able to steal $700m worth of ETH collateral and be able to print new Dai at will. This attack would spread throughout the whole DeFi space as Dai is used as backing collateral in other protocols. Further, the attacker can use his Dai to trade other currencies worth around $230m. ",(0,o.kt)("a",{parentName:"p",href:"https://arxiv.org/abs/2002.08099"},"We give a more detailed analysis in our paper.")),(0,o.kt)("h2",{id:"counter-measure"},"Counter measure"),(0,o.kt)("p",null,"Maker should put a new governance contract in place that prevents flash loans from attacking their system. Specifically, a new governance contract should be able to be checked by the Maker Foundation for malicious code and give enough time to react. At the bare minimum, a new governance contract should not be able to go live within a single transaction. That way, the attacker can likely not profit from the attack and thus not repay the flash loan.\nIf the attacker cannot repay the flash loan, the attack is like it would have never happened."),(0,o.kt)("p",null,"Maker is putting such a contract to vote on Friday, 12pm PST, February 21, 2020. ",(0,o.kt)("a",{parentName:"p",href:"https://forum.makerdao.com/t/all-mkr-holders-on-friday-12pm-pst-please-vote-for-the-gsm-to-be-activated/1303/2"},"The proposed contract would activate the Governance Security Module (GSM) and prevent such a flash loan attack.")))}d.isMDXComponent=!0},2125:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/eth-locked-dydx-71e47f9a802fa4f73b434ccd6f490d88.webp"},590:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/eth-locked-49ebf20958f73b922d3811a3aceafa28.webp"},6187:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/flash-loan-ad22ea3dffc0db7e13540ee02ccca7ac.webp"},8314:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/mkr_locked-79e0b1ef4dcbf0f4e43816d4364c5e75.webp"},13:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/twitter-ca74db5863009f30e89defb4e12a4a17.webp"}}]);